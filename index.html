<!DOCTYPE html>
<html lang="de">
<head>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700&family=Cinzel:wght@700&family=Montserrat:wght@500&display=swap" rel="stylesheet">
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Klingenaufstieg</title>
  <link rel="stylesheet" href="./css/style.css">
</head>
<body>
  <style>
    /* Action ability icon cooldown overlay */
    #charSelectStart option[disabled]{
      color:#888;
      font-style:italic;
    }
    #charSelectStart option[disabled]::before{ content:'üîí '; }
    .icon-has-cd { position:relative; overflow:hidden; }
    .icon-has-cd.dimmed { filter:grayscale(.85) brightness(.6) contrast(1.05); }
    .icon-has-cd .cd-slice {
      position:absolute; inset:0; display:block;
      background:conic-gradient(var(--cd-color,#ffe600) calc(var(--cd-pct,0)*1%), rgba(0,0,0,0) 0);
      -webkit-mask:radial-gradient(circle at 50% 50%, #000 63%, #0000 64%);
      mask:radial-gradient(circle at 50% 50%, #000 63%, #0000 64%);
      mix-blend-mode:screen;
      pointer-events:none;
      opacity:.0; transition:opacity .25s;
    }
    .icon-has-cd.dimmed .cd-slice { opacity:.55; }
    .icon-has-cd.ready-pulse { animation:abilityPulse 0.85s ease; }
    @keyframes abilityPulse { 0%{transform:scale(.9); filter:brightness(.7);} 45%{transform:scale(1.08); filter:brightness(1.5);} 100%{transform:scale(1); filter:brightness(1);} }
  </style>
  <!-- Immer sichtbares Overlay f√ºr Start-Auswahl -->
  <div id="nextStartInfo" style="display:none;position:fixed;bottom:24px;right:24px;z-index:99999;background:#23232a;padding:12px 22px 10px 22px;border-radius:12px;box-shadow:0 2px 12px #000a;color:#d5c437;font-size:1.15em;font-weight:bold;text-shadow:0 2px 8px #000b,0 0 8px #d5c43766;pointer-events:none;user-select:none;">
    N√§chster Start: -
  </div>
  <button id="forceTestModeBtn" style="position:fixed;top:220px;left:12px;z-index:99999;font-size:1.2rem;padding:8px 18px;border-radius:8px;background:#333;color:#fff;font-weight:bold;box-shadow:0 0 8px #000a;transition:background 0.2s,box-shadow 0.2s;">Test Modus</button>
  <div class="overlay" id="pauseOverlay" style="z-index:99999;">
    <div class="panel" style="background:rgba(24,18,38,0.98);border-radius:22px;box-shadow:0 8px 48px #000b;padding:36px 32px 28px 32px;display:flex;flex-direction:column;align-items:center;gap:18px;min-width:340px;max-width:90vw;">
      <div style="display:flex;align-items:center;gap:12px;">
        <div style="width:42px;height:42px;border-radius:12px;display:flex;align-items:center;justify-content:center;background:linear-gradient(145deg,#2d2616,#1c1911);border:1px solid #e6c97a55;box-shadow:0 0 0 1px #000 inset;filter:drop-shadow(0 2px 10px #0008);font-size:22px;">‚è∏Ô∏è</div>
        <h2 style="margin:0;font-size:2em;font-family:'Cinzel','Orbitron',serif;font-weight:900;color:#e6c97a;text-shadow:0 3px 22px #000b,0 0 12px #e6c97a66;letter-spacing:2px;">PAUSE</h2>
      </div>
      <div class="btns" style="display:flex;gap:12px;">
        <button id="resumeBtn" style="padding:14px 28px;border-radius:12px;background:#7a38e1;color:#fff;font-weight:900;cursor:pointer;border:0;font-size:1.15em;letter-spacing:1px;box-shadow:0 2px 12px #7a38e188;">Weiter (ESC)</button>
        <button id="restartBtn1" style="padding:14px 28px;border-radius:12px;background:#38e1d7;color:#222;font-weight:900;cursor:pointer;border:0;font-size:1.15em;letter-spacing:1px;box-shadow:0 2px 12px #38e1d788;">Neustart (R)</button>
      </div>
      <div id="pauseHint" style="font-size:12px;color:#ddd;opacity:.85;">Tipp: √ñffne das Startmen√º mit R (gedr√ºckt + R)</div>
    </div>
  </div>
  <div class="overlay" id="gameOver" style="z-index:99999;">
    <div class="panel" style="background:rgba(24,18,38,0.98);border-radius:22px;box-shadow:0 8px 48px #000b;padding:48px 44px 36px 44px;display:flex;flex-direction:column;align-items:center;gap:24px;min-width:340px;max-width:90vw;">
      <h1 style="font-size:3.2em;font-family:'Cinzel','Orbitron',serif;font-weight:900;color:#e6c97a;text-shadow:0 4px 32px #000b,0 0 18px #e6c97a88,0 0 2px #fff;letter-spacing:2px;margin-bottom:0.2em;margin-top:0;letter-spacing:3px;">GAME OVER</h1>
      <button id="restartBtnReload" style="padding:18px 44px;border-radius:12px;background:#38e1d7;color:#222;font-weight:900;cursor:pointer;border:0;font-size:1.35em;letter-spacing:1px;box-shadow:0 2px 12px #38e1d788,0 0 0 #0000;margin-top:24px;">Neustart</button>
    </div>
  </div>
  <!-- Loot Choice Overlay -->
  <div class="overlay" id="lootChoiceOverlay" style="z-index:99999;">
    <div class="panel" style="background:rgba(24,18,38,0.98);border-radius:22px;box-shadow:0 8px 48px #000b;padding:28px 24px 22px 24px;display:flex;flex-direction:column;align-items:center;gap:16px;min-width:360px;max-width:92vw;">
      <h2 style="font-size:1.6em;font-family:'Cinzel','Orbitron',serif;font-weight:900;color:#e6c97a;text-shadow:0 2px 18px #000b,0 0 8px #e6c97a88;letter-spacing:1.5px;margin:6px 0 2px 0;">W√§hle 1 von 3</h2>
      <div id="lootChoiceCards" style="display:flex;flex-wrap:wrap;gap:12px;justify-content:center;align-items:stretch;min-width:320px;"></div>
      <div style="font-size:12px;color:#ddd;opacity:.85;">Klicke oder dr√ºcke 1‚Äì3</div>
    </div>
  </div>
  <div class="overlay show" id="startMenu" style="z-index:99999;">
    <div class="panel">
  <h1 style="margin:6px 0 10px 0;">Klingenaufstieg</h1>
      <p style="margin:0 0 12px 0;">Bevor es losgeht, w√§hle eine Waffe oder fahre mit Start fort. Fahre mit der Maus √ºber eine Waffe, um ihre Werte zu sehen.</p>
      <div id="charInfoBox" style="margin:0 auto 10px auto;max-width:420px;background:#23232a;color:#fff;padding:14px 18px;border-radius:10px;box-shadow:0 4px 16px #000a;display:none;text-align:left;font-size:15px;line-height:1.4;"></div>
  <!-- Alte Waffen-Auswahl entfernt -->
        <div style="display:flex;justify-content:center;margin-bottom:12px;">
          <canvas id="characterPreview" width="96" height="96" style="background:#23232a;border-radius:12px;border:2px solid #333;box-shadow:0 2px 12px #000a;"></canvas>
        </div>
        <!-- Charakter- und Waffenauswahl direkt unter der Animation -->
        <div id="previewSelectBox">
          <div class="select-wrap">
            <label for="charSelectStart">Charakter</label>
            <select id="charSelectStart" data-bully-locked="1">
              <option value="Fred">Fred</option>
              <option value="Bully" disabled>Bully (gesperrt)</option>
            </select>
          </div>
          <div class="select-wrap">
            <label for="weaponSelectStart">Waffe</label>
            <select id="weaponSelectStart">
              <option value="Sword">Schwert</option>
              <option value="Dagger">Dolch</option>
              <option value="Halberd">Halbarde</option>
              <option value="Staff">Stab</option>
            </select>
          </div>
          <button id="savePreviewSelectionBtn">Auswahl speichern</button>
        </div>
      <div style="display:flex;flex-direction:column;align-items:center;gap:8px;">
  <input id="playerNameInputStart" type="text" maxlength="16" placeholder="Dein Name" style="font-size:1.2em;padding:8px 16px;border-radius:8px;border:1px solid #aaa;margin-bottom:8px;max-width:220px;text-align:center;">
  <button id="startBtn" disabled style="padding:14px 32px;border-radius:10px;background:#7a38e1;color:#fff;font-weight:900;cursor:pointer;border:0;font-size:1.35em;letter-spacing:1px;box-shadow:0 2px 12px #7a38e188,0 0 0 #0000;margin-bottom:2px;">Start</button>
    <button id="testBossBtn" style="padding:12px 28px;border-radius:10px;background:#38e1d7;color:#222;font-weight:900;cursor:pointer;border:0;font-size:1.15em;letter-spacing:1px;box-shadow:0 2px 12px #38e1d788,0 0 0 #0000;margin-bottom:2px;">Testmodus: Boss-Debug</button>
    <div id="weaponTooltip" style="min-width:220px;padding:8px 12px;border-radius:6px;background:#111;border:1px solid #333;color:#fff;display:none;">Waffe Info</div>
      </div>
    </div>
  <!-- Boss-Debug-Overay -->
  <div id="bossDebugOverlay" style="position:fixed;top:16px;right:16px;z-index:99999;background:#23232a;padding:14px 18px 10px 18px;border-radius:10px;box-shadow:0 2px 12px #000a;color:#fff;display:none;min-width:220px;font-size:16px;line-height:1.5;">
    <div id="bossDebugTitle" style="font-weight:bold;font-size:18px;margin-bottom:6px;">Boss-Debug</div>
    <div id="bossDebugDmg">Schaden: 0</div>
    <div id="bossDebugBuffs">Buffs: -</div>
    <div id="bossDebugDebuffs">Debuffs: -</div>
  <div id="bossDebugLog" style="margin-top:8px;font-size:14px;max-height:120px;overflow-y:auto;background:#18181c;border-radius:6px;padding:6px 8px 4px 8px;"></div>
    <button id="bossAttackBtn" style="margin-top:8px;">Boss greift an</button>
  </div>
  </div>

  <canvas id="game"></canvas>
  <div class="hud">
    <button id="testModeBtn" style="position:fixed;top:8px;right:8px;z-index:1000;padding:8px 16px;border-radius:8px;background:#38e1d7;color:#222;font-weight:bold;cursor:pointer;display:none;">Test Mode: AUS</button>
    <div style="position:fixed;top:16px;left:50%;transform:translateX(-50%);z-index:2000;display:flex;flex-direction:column;align-items:center;width:420px;max-width:90vw;gap:8px;">
  <!-- Alte gro√üe HP-Leiste ausgeblendet (ersetzt durch neue Mini-HP-Bar im neuen HUD) -->
  <div class="bar hp" style="display:none;position:relative;width:440px;min-width:320px;max-width:540px;margin-top:64px;height:32px;">
        <div class="labels" style="justify-content:flex-start;width:100%;"><span style="margin-left:8px;font-weight:bold;">HP</span><span id="hpPercent" style="width:100%;display:flex;justify-content:center;font-weight:bold;">100%</span></div>
        <div class="fill ghost" id="hpFillGhost" style="width:100%;opacity:.28;filter:brightness(.75);"></div>
        <div class="fill" id="hpFill" style="width:100%"></div>
        <div class="hp-gloss-layer" id="hpGloss"></div>
        <div class="hp-edge-spark" id="hpEdgeSpark" style="display:none;"></div>
      </div>
  <!-- Buff Tags komplett deaktiviert -->
  <div class="buffs" id="buffTagsBuffs" style="display:none;flex-direction:row;gap:8px;overflow-x:auto;margin-top:-8px;margin-left:48px;border:none;"></div>
    </div>

    <div id="playerName" style="display:none;
      position:fixed;
      top:75px;
      left: 70px;
      z-index:2100;
      font-size: 1.6em;
      font-family: 'Cinzel', 'Orbitron', serif;
      font-weight: 700;
      color: #e8e8f0;
      text-shadow: 0 2px 18px #000, 0 0 18px #e6c97a99, 0 0 2px #fff;
      margin: 0;
      letter-spacing: 2.5px;
      filter: brightness(1.08) drop-shadow(0 2px 6px #222a);
      text-align: left;
      width: 340px;
      max-width: 90vw;
      line-height: 1.1;
      padding-left: 24px;
      border-bottom: 2px solid #e6c97a55;
      background: rgba(20,16,8,0.32);
      border-radius: 0 0 18px 18px;
      box-shadow: 0 2px 18px #000a, 0 0 0 #0000;
      pointer-events: none;
    ">Spielername</div>
    <!-- Alte Stats-Bar ausgeblendet, neue HUD-Leiste unten definiert -->
    <div id="oldStatsBar" style="display:none;position:fixed;top:16px;left:24px;right:24px;z-index:1100;">
      <!-- (Inhalt beibehalten f√ºr Kompatibilit√§t) -->
      <div class="stats stats-horizontal">
        <div><span id="lvl">1</span><span id="kills">0</span><span id="dmg">25</span><span id="spd">200</span></div>
      </div>
    </div>
    <!-- Neue High-End HUD Bar -->
  <div id="newTopHud" style="position:fixed;top:14px;left:50%;transform:translateX(calc(-50% - 120px));z-index:2500;display:flex;flex-direction:row;align-items:stretch;gap:18px;font-family:'Montserrat','Orbitron',sans-serif;font-size:14px;letter-spacing:.5px;">
      <div class="hud-block ident" data-section="ident">
        <div class="player-name" id="hudPlayerName">Spieler</div>
        <div class="char-weapon" id="hudCharWeapon">- / -</div>
        <div class="stars-line" id="hudStarsLine">‚òÖ0</div>
      </div>
      <div class="hud-block core" data-section="core">
        <div class="row unified">
          <div class="item lvl"><span class="icon">üèÖ</span><span class="label">Lvl</span><span class="val" id="hudLvl">1</span></div>
          <div class="item kills"><span class="icon">‚öîÔ∏è</span><span class="label">Kills</span><span class="val" id="hudKills">0</span></div>
          <div class="item stars"><span class="icon">‚òÖ</span><span class="label">Stars</span><span class="val" id="hudStars">0</span></div>
          <div class="item dmg"><span class="icon">üó°Ô∏è</span><span class="label">Dmg</span><span class="val" id="hudDmg">0</span></div>
          <div class="item movespd"><span class="icon">üí®</span><span class="label">MS</span><span class="val" id="hudMS">0</span></div>
          <div class="item weaponlvl"><span class="icon">üó≤</span><span class="label">Wpn</span><span class="val" id="hudWeaponLvl">1</span></div>
        </div>
          <!-- Neue kompakte HP-Bar -->
          <div class="mini-bar hp" id="hudHpBar">
            <div class="fill ghost" id="hudHpGhost"></div>
            <div class="fill" id="hudHpFill"></div>
            <div class="hint" id="hudHpHint">HP 100%</div>
          </div>
        <!-- XP & Weapon Level Mini-Bars entfernt -->
        <!-- <div class="bar-row">
          <div class="mini-bar xp" id="hudXpBar"><div class="fill" id="hudXpFill"></div><div class="hint" id="hudXpHint">0 / 0</div></div>
          <div class="mini-bar weapon" id="hudWeaponBar"><div class="fill" id="hudWeaponFill"></div><div class="hint" id="hudWeaponHint">Wpn 1</div></div>
        </div> -->
      </div>
      <!-- HUD Buff Block entfernt -->
      <div class="hud-block buffs" data-section="buffs" style="display:none;">
        <div class="buffs-scroller" id="hudBuffTags"></div>
      </div>
    </div>
  <div id="liveScore" style="display:none;position:fixed;top:24px;left: 95%;transform:translateX(-50%);z-index:9999;font-size:2.8em;font-family:'Cinzel','Orbitron',serif;font-weight:900;color:#e6c97a;text-shadow:0 2px 18px #000,0 0 18px #e6c97a99,0 0 2px #fff;letter-spacing:2px;pointer-events:none;user-select:none;filter:brightness(1.08);">Score: 0</div>
  <div id="rightHudStack" style="position:fixed;right:24px;top:180px;display:none;flex-direction:column;align-items:flex-end;gap:14px;z-index:2100;">
    <div class="slots" id="weaponSlots" style="position:relative;right:auto;top:auto;margin:0;"></div>
    <div id="actionKeys" style="position:relative;right:auto;top:auto;display:flex;flex-direction:column;gap:10px;align-items:flex-end;font-family:'Montserrat','Orbitron',sans-serif;">
    <div class="action-key" data-key="Q" style="display:flex;align-items:center;gap:10px;background:rgba(20,16,8,0.55);backdrop-filter:blur(4px);padding:10px 14px 10px 16px;border:1px solid #38e1d744;border-radius:14px;box-shadow:0 4px 14px -4px #000a,0 0 0 1px #000 inset;min-width:180px;transition:background .25s, box-shadow .25s;">
      <div id="actionQIcon" class="icon-has-cd" style="position:relative;width:38px;height:38px;border:2px solid #38e1d799;border-radius:10px;display:flex;align-items:center;justify-content:center;font-weight:800;font-size:18px;color:#38e1d7;background:linear-gradient(145deg,#1a2c2c,#111b1b);text-shadow:0 0 8px #38e1d788,0 2px 12px #000;box-shadow:0 0 12px #000 inset,0 0 0 1px #000;">Q</div>
      <div style="display:flex;flex-direction:column;line-height:1.15;">
  <span style="font-size:14px;font-weight:700;letter-spacing:.5px;color:#38e1d7;text-shadow:0 2px 8px #000;">Tempo (Q)</span>
  <span id="actionQDesc" style="font-size:12px;opacity:0.85;color:#ddd;">Tempo +40% (3s)</span>
        <div style="margin-top:4px;position:relative;width:110px;height:6px;background:#111a1a;border:1px solid #38e1d755;border-radius:4px;overflow:hidden;">
          <div id="actionQCd" style="position:absolute;left:0;top:0;height:100%;width:0;background:linear-gradient(90deg,#38e1d7,#1fa0ff);box-shadow:0 0 8px #38e1d7aa;"></div>
        </div>
      </div>
    </div>
    <div class="action-key" data-key="E" style="display:flex;align-items:center;gap:10px;background:rgba(20,16,8,0.55);backdrop-filter:blur(4px);padding:10px 14px 10px 16px;border:1px solid #e6c97a44;border-radius:14px;box-shadow:0 4px 14px -4px #000a,0 0 0 1px #000 inset;min-width:180px;transition:background .25s, box-shadow .25s;">
      <div id="actionEIcon" class="icon-has-cd" style="position:relative;width:38px;height:38px;border:2px solid #e6c97a99;border-radius:10px;display:flex;align-items:center;justify-content:center;font-weight:800;font-size:18px;color:#ffe600;background:linear-gradient(145deg,#2d2616,#1c1911);text-shadow:0 0 8px #ffe60088,0 2px 12px #000;box-shadow:0 0 12px #000 inset,0 0 0 1px #000;">E</div>
      <div style="display:flex;flex-direction:column;line-height:1.15;">
        <span style="font-size:14px;font-weight:700;letter-spacing:.5px;color:#ffe600;text-shadow:0 2px 8px #000;">Heilung (E)</span>
        <span id="actionEDesc" style="font-size:12px;opacity:0.85;color:#ddd;">Heilimpuls (5%)</span>
        <div style="margin-top:4px;position:relative;width:110px;height:6px;background:#19150c;border:1px solid #e6c97a55;border-radius:4px;overflow:hidden;">
          <div id="actionECd" style="position:absolute;left:0;top:0;height:100%;width:0;background:linear-gradient(90deg,#ffe600,#bfa14a);box-shadow:0 0 8px #ffe600aa;"></div>
        </div>
      </div>
    </div>
    <!-- R F√§higkeit (Spin oder Meteor) -->
    <div class="action-key" data-key="R" id="rActionBlock" style="display:flex;align-items:center;gap:10px;background:rgba(32,12,36,0.55);backdrop-filter:blur(4px);padding:10px 14px 10px 16px;border:1px solid #b448ff55;border-radius:14px;box-shadow:0 4px 14px -4px #000a,0 0 0 1px #000 inset;min-width:190px;transition:background .25s, box-shadow .25s;">
      <div id="actionRIcon" class="icon-has-cd" style="position:relative;width:42px;height:42px;border:2px solid #b448ffcc;border-radius:11px;display:flex;align-items:center;justify-content:center;font-weight:800;font-size:18px;color:#d68bff;background:linear-gradient(145deg,#32163d,#1c0f23);text-shadow:0 0 10px #d68bff99,0 2px 14px #000;box-shadow:0 0 14px #000 inset,0 0 0 1px #000;letter-spacing:1px;">R</div>
      <div style="display:flex;flex-direction:column;line-height:1.12;">
        <span id="actionRLabel" style="font-size:14px;font-weight:700;letter-spacing:.5px;color:#d68bff;text-shadow:0 2px 8px #000;">Ult (R)</span>
        <span id="actionRDesc" style="font-size:12px;opacity:0.85;color:#e8d7f5;">L√§dt...</span>
        <div style="margin-top:4px;position:relative;width:120px;height:6px;background:#231426;border:1px solid #b448ff55;border-radius:4px;overflow:hidden;">
          <div id="actionRCd" style="position:absolute;left:0;top:0;height:100%;width:0;background:linear-gradient(90deg,#b448ff,#7a38e1);box-shadow:0 0 8px #b448ffaa;"></div>
        </div>
      </div>
    </div>
    <!-- F F√§higkeit (Curse) -->
    <div class="action-key" data-key="F" id="fActionBlock" style="display:flex;align-items:center;gap:10px;background:rgba(24,10,38,0.55);backdrop-filter:blur(4px);padding:10px 14px 10px 16px;border:1px solid #7d48ff55;border-radius:14px;box-shadow:0 4px 14px -4px #000a,0 0 0 1px #000 inset;min-width:190px;transition:background .25s, box-shadow .25s;">
      <div id="actionFIcon" class="icon-has-cd" style="position:relative;width:40px;height:40px;border:2px solid #7d48ffcc;border-radius:10px;display:flex;align-items:center;justify-content:center;font-weight:800;font-size:17px;color:#bb9dff;background:linear-gradient(145deg,#2a163d,#170f23);text-shadow:0 0 8px #bb9dff99,0 2px 12px #000;box-shadow:0 0 12px #000 inset,0 0 0 1px #000;letter-spacing:1px;">F</div>
      <div style="display:flex;flex-direction:column;line-height:1.12;">
  <span id="actionFLabel" style="font-size:14px;font-weight:700;letter-spacing:.5px;color:#bb9dff;text-shadow:0 2px 8px #000;">Paralyse (F)</span>
        <span id="actionFDesc" style="font-size:12px;opacity:0.85;color:#dcd2f5;">L√§dt...</span>
        <div style="margin-top:4px;position:relative;width:120px;height:6px;background:#1e1426;border:1px solid #7d48ff55;border-radius:4px;overflow:hidden;">
          <div id="actionFCd" style="position:absolute;left:0;top:0;height:100%;width:0;background:linear-gradient(90deg,#7d48ff,#4028aa);box-shadow:0 0 8px #7d48ffaa;"></div>
        </div>
      </div>
    </div>
    <!-- Rechtsklick Dash Anzeige -->
    <div class="action-key" id="rcDashBlock" style="display:flex;align-items:center;gap:10px;background:rgba(12,22,28,0.60);backdrop-filter:blur(4px);padding:8px 12px 8px 14px;border:1px solid #35b8ff55;border-radius:12px;box-shadow:0 4px 12px -4px #000a,0 0 0 1px #000 inset;min-width:170px;transition:background .25s, box-shadow .25s;">
      <div style="position:relative;width:32px;height:32px;border:2px solid #35b8ffaa;border-radius:9px;display:flex;align-items:center;justify-content:center;font-weight:800;font-size:14px;color:#8fdfff;background:linear-gradient(145deg,#162c34,#0c171a);text-shadow:0 0 6px #35b8ff88,0 1px 8px #000;box-shadow:0 0 10px #000 inset,0 0 0 1px #000;">RC</div>
      <div style="display:flex;flex-direction:column;line-height:1.1;">
        <span style="font-size:13px;font-weight:700;letter-spacing:.5px;color:#8fdfff;text-shadow:0 2px 6px #000;">Dash (Rechts)</span>
        <span id="rcDashDesc" style="font-size:11px;opacity:0.9;color:#cfefff;">Laden...</span>
        <div style="margin-top:3px;position:relative;width:100px;height:5px;background:#0d1c22;border:1px solid #35b8ff55;border-radius:4px;overflow:hidden;">
          <div id="rcDashCd" style="position:absolute;left:0;top:0;height:100%;width:0;background:linear-gradient(90deg,#35b8ff,#1f78ff);box-shadow:0 0 6px #35b8ffaa;"></div>
        </div>
      </div>
    </div>
    </div>
  </div>
  </div>

  <div class="cornerTips"></div>

  

  <div id="expBarBottom" style="position:fixed;left:0;right:0;bottom:0;height:12px;background:rgba(20,16,8,0.82);z-index:2000;box-shadow:0 -2px 18px #000a;border-top:2px solid #e6c97a77;">

    <div id="expBarFill" style="height:100%;width:0%;background:linear-gradient(90deg,#e6c97a,#bfa14a 60%,#7a38e1 100%);transition:width 120ms linear;box-shadow:0 0 12px #e6c97a88;"></div>
  </div>
  <!-- Bottom Ability Bar Container -->
  <div id="abilityBar" style="position:fixed;left:50%;transform:translateX(-50%);bottom:14px;z-index:2100;display:flex;flex-direction:row;gap:10px;padding:10px 18px 12px 18px;background:rgba(18,14,10,0.65);backdrop-filter:blur(6px);border-radius:18px;border:1px solid #e6c97a33;box-shadow:0 4px 18px -4px #000c,0 0 0 1px #000 inset;min-width:560px;justify-content:center;align-items:flex-end;">
    <!-- Slots werden dynamisch per JS gef√ºllt -->
  </div>
  <script src="./js/characterAnimations.js"></script>
  <!-- Hauptspiel-Logik: zuvor war hier f√§lschlich ../js/script.js (eine Ebene zu hoch) -->
  <script src="./js/script.js"></script>
  <script src="./js/abilityBar.js"></script>
  <script>
    // Bully tempor√§r gesperrt: sichtbar aber nicht w√§hlbar.
    (function lockBully(){
      const sel = document.getElementById('charSelectStart');
      if(!sel) return;
      const bullyOpt = Array.from(sel.options).find(o=>o.value.toLowerCase()==='bully');
      if(bullyOpt){ bullyOpt.disabled = true; bullyOpt.textContent = 'Bully (gesperrt)'; }
      sel.addEventListener('change',()=>{
        if(sel.value.toLowerCase()==='bully'){
          sel.value = 'Fred';
          if(typeof showMeteorToast==='function') showMeteorToast('Bully ist aktuell gesperrt.');
        }
      });
    })();
  </script>
  <style>
    /* New Top HUD Styling */
    #newTopHud{filter:drop-shadow(0 4px 20px #000a);} 
    #newTopHud .hud-block{position:relative;display:flex;flex-direction:column;gap:6px;padding:14px 18px 12px 18px;background:linear-gradient(135deg,rgba(28,24,18,0.85),rgba(16,12,8,0.72));border:1px solid #e6c97a33;border-radius:18px;backdrop-filter:blur(6px);box-shadow:0 0 0 1px #000 inset,0 4px 18px -4px #000c;} 
  #newTopHud .hud-block.ident{min-width:180px;max-width:210px;display:flex;flex-direction:column;justify-content:center;gap:4px;background:linear-gradient(145deg,rgba(122,56,225,0.18),rgba(20,16,12,0.85));border:1px solid #7a38e144;} 
  #newTopHud .hud-block.ident .player-name{font-family:'Cinzel','Orbitron',serif;font-size:20px;font-weight:800;letter-spacing:2px;color:#e6c97a;text-shadow:0 2px 14px #000,0 0 12px #e6c97a66;} 
  #newTopHud .hud-block.ident .char-weapon{font-size:11px;font-weight:600;opacity:.85;color:#d5c9aa;letter-spacing:1px;text-transform:uppercase;} 
  #newTopHud .hud-block.ident .stars-line{font-size:12px;font-weight:700;color:#ffe6a8;text-shadow:0 0 6px #000;} 
  #newTopHud .hud-block.core{min-width:620px;} 
  #newTopHud .hud-block .row.unified{flex-wrap:wrap;gap:14px;} 
    #newTopHud .hud-block .row{display:flex;flex-direction:row;gap:14px;justify-content:flex-start;} 
    #newTopHud .hud-block .item{display:flex;align-items:center;gap:4px;padding:4px 10px 4px 8px;background:rgba(0,0,0,0.35);border:1px solid #e6c97a22;border-radius:10px;font-weight:600;color:#e8e2d2;position:relative;line-height:1;} 
    #newTopHud .hud-block .item .icon{font-size:15px;filter:drop-shadow(0 0 4px #000);} 
    #newTopHud .hud-block .item .val{font-family:'Cinzel','Orbitron',serif;font-weight:700;color:#ffe6a8;text-shadow:0 0 8px #000,0 0 6px #e6c97a66;font-size:15px;letter-spacing:1px;} 
    #newTopHud .hud-block .item .label{opacity:.65;font-size:11px;text-transform:uppercase;letter-spacing:1px;font-weight:700;color:#bfae7a;} 
    #newTopHud .hud-block .row.top .item{background:rgba(255,230,168,0.08);} 
    #newTopHud .hud-block .row.mid .item{background:rgba(134,112,64,0.10);} 
    #newTopHud .hud-block .item::after{content:'';position:absolute;inset:0;border-radius:inherit;pointer-events:none;background:linear-gradient(145deg,rgba(255,230,168,0.12),rgba(255,230,168,0));opacity:0;transition:opacity .4s;} 
    #newTopHud .hud-block .item:hover::after{opacity:.55;} 
    #newTopHud .mini-bar{position:relative;height:14px;flex:1;background:rgba(0,0,0,0.45);border:1px solid #e6c97a33;border-radius:8px;overflow:hidden;display:flex;align-items:center;margin-top:2px;} 
    #newTopHud .bar-row{display:flex;flex-direction:row;gap:12px;margin-top:2px;} 
    #newTopHud .mini-bar .fill{position:absolute;left:0;top:0;bottom:0;width:0%;background:linear-gradient(90deg,#e6c97a,#bfa14a 60%,#7a38e1);box-shadow:0 0 12px #e6c97a55;} 
    #newTopHud .mini-bar.weapon .fill{background:linear-gradient(90deg,#7a38e1,#38e1d7);} 
    #newTopHud .mini-bar .hint{position:relative;z-index:2;width:100%;text-align:center;font-size:10px;font-weight:600;letter-spacing:1px;color:#e8dbbb;text-shadow:0 0 6px #000;} 
  /* HP Mini-Bar Styling */
  #newTopHud .mini-bar.hp{margin-top:4px;height:16px;background:rgba(48,12,12,0.55);border:1px solid #ff4d4d55;box-shadow:0 0 0 1px #000 inset,0 0 12px -4px #ff1e1e55;border-radius:9px;overflow:hidden;position:relative;}
  #newTopHud .mini-bar.hp .fill{background:linear-gradient(90deg,#ff1e33,#b40018 60%,#4b0016);box-shadow:0 0 12px #ff1e1e55;transition:width 120ms linear;}
  #newTopHud .mini-bar.hp .fill.ghost{background:linear-gradient(90deg,#ff8d96,#ff455a 60%,#b11a2a);opacity:.35;filter:saturate(1.1) brightness(.95);box-shadow:none;transition:width 650ms cubic-bezier(.25,.1,.25,1);}
  #newTopHud .mini-bar.hp.low{animation:hpPulse 1.2s ease-in-out infinite;}
  #newTopHud .mini-bar.hp.low .fill{filter:brightness(1.15) contrast(1.1);} 
  #newTopHud .mini-bar.hp .hint{font-size:10px;letter-spacing:1px;font-weight:700;color:#ffd9d9;text-shadow:0 0 6px #000,0 0 8px #ff1e1e55;}
  @keyframes hpPulse{0%,100%{box-shadow:0 0 0 1px #000 inset,0 0 10px -2px #ff1e1e44;}50%{box-shadow:0 0 0 1px #000 inset,0 0 18px 0 #ff1e1e88;}}
    #newTopHud .hud-block.buffs{min-width:180px;max-width:260px;} 
    #newTopHud .buffs-scroller{display:flex;flex-direction:row;gap:6px;overflow-x:auto;padding:4px 4px 2px 4px;max-width:240px;} 
    #newTopHud .buffs-scroller::-webkit-scrollbar{height:6px;} 
    #newTopHud .buffs-scroller::-webkit-scrollbar-track{background:#0004;} 
    #newTopHud .buffs-scroller::-webkit-scrollbar-thumb{background:#e6c97a55;border-radius:4px;} 
    @media (max-width:980px){#newTopHud{flex-direction:column;left:12px;transform:none;} #newTopHud .hud-block.core{min-width:0;width:calc(100vw - 32px);} }
  </style>
  <script>
    // Subtle button hover improvements for pause overlay
    (function enhancePauseButtons(){
      const css = `#pauseOverlay .panel button{transition:transform .12s ease, filter .2s ease, box-shadow .2s ease;}#pauseOverlay .panel button:hover{transform:translateY(-1px);filter:brightness(1.05);}#pauseOverlay .panel button:active{transform:translateY(0);}#pauseOverlay .panel button:focus{outline:none;box-shadow:0 0 0 2px #000 inset, 0 0 0 2px #e6c97a55;}`;
      if(!document.getElementById('pauseOverlayBtnStyles')){
        const s=document.createElement('style'); s.id='pauseOverlayBtnStyles'; s.textContent=css; document.head.appendChild(s);
      }
    })();
    // Loot Choice Overlay helpers (basic styles injected here to keep it self-contained)
    (function ensureLootChoiceStyles(){
      if(document.getElementById('lootChoiceStyles')) return;
      const s = document.createElement('style');
      s.id = 'lootChoiceStyles';
      s.textContent = `
        #lootChoiceCards .card{cursor:pointer;display:flex;flex-direction:column;gap:8px;min-width:180px;max-width:220px;padding:14px 14px 12px 14px;background:rgba(18,14,10,0.65);backdrop-filter:blur(6px);border-radius:14px;border:1px solid #e6c97a33;box-shadow:0 4px 18px -4px #000c,0 0 0 1px #000 inset;transition:transform .12s ease, box-shadow .2s ease, border-color .2s ease;}
        #lootChoiceCards .card:hover{transform:translateY(-2px);box-shadow:0 10px 28px -6px #000c,0 0 0 1px #000 inset;border-color:#e6c97a66;}
        #lootChoiceCards .card .top{display:flex;align-items:center;gap:8px;}
        #lootChoiceCards .card .icon{font-size:22px;filter:drop-shadow(0 0 6px #000);} 
        #lootChoiceCards .card .name{font-family:'Cinzel','Orbitron',serif;font-weight:800;letter-spacing:1px;color:#ffe6a8;text-shadow:0 0 8px #000,0 0 6px #e6c97a66;font-size:16px;}
        #lootChoiceCards .card .desc{font-size:12px;line-height:1.25;color:#ddd;opacity:0.95;}
        #lootChoiceCards .card .key{align-self:flex-end;font-size:11px;opacity:.65;color:#cbb98a;}
        #lootChoiceOverlay .panel{animation:popin .18s ease-out;}
        @keyframes popin{0%{transform:scale(.94);opacity:0;}100%{transform:scale(1);opacity:1;}}
      `;
      document.head.appendChild(s);
    })();
    // New HUD Update Loop
    (function initNewHud(){
      function pct(a,b){ if(!b||b<=0) return 0; return Math.max(0,Math.min(1,a/b)); }
      function update(){
        try {
          const p = window.player; if(!p){ requestAnimationFrame(update); return; }
          // Identity Block
          const nameEl = document.getElementById('hudPlayerName');
          const cwEl = document.getElementById('hudCharWeapon');
          const starLine = document.getElementById('hudStarsLine');
          if(nameEl){
            let pname = (window.playerDisplayName && window.playerDisplayName.trim()) || (p && p.name) || 'Spieler';
            if(typeof pname === 'string' && pname.length>16) pname = pname.slice(0,16);
            nameEl.textContent = pname;
          }
          if(cwEl){
            let charTxt = (window.selectedCharacter||'-'); if(charTxt) charTxt = charTxt.charAt(0).toUpperCase()+charTxt.slice(1);
            let wTxt='-'; try { if(window.player && window.weapons && Array.isArray(window.weapons) && window.player.weaponIndex!=null){ const w=window.weapons[window.player.weaponIndex]; if(w && w.id) wTxt = w.id.charAt(0).toUpperCase()+w.id.slice(1); } } catch(_e){}
            cwEl.textContent = charTxt+' / '+wTxt;
          }
          if(starLine){
            const total = (typeof window.kristofBossDefeated==='number' ? window.kristofBossDefeated : 0) || 0;
            const cap = 5;
            const shown = Math.min(cap, total);
            let txt = '‚òÖ'+ shown;
            if(total>cap) txt += ' x'+ total;
            starLine.textContent = txt;
          }
          const lvlEl = document.getElementById('hudLvl');
          const xpEl = document.getElementById('hudXp');
          const killsEl = document.getElementById('hudKills');
          const starsEl = document.getElementById('hudStars');
          const dmgEl = document.getElementById('hudDmg');
          const apsEl = document.getElementById('hudAPS');
          const msEl = document.getElementById('hudMS');
          const wLvlEl = document.getElementById('hudWeaponLvl');
          const xpFill = document.getElementById('hudXpFill');
          const xpHint = document.getElementById('hudXpHint');
          const wFill = document.getElementById('hudWeaponFill');
          const wHint = document.getElementById('hudWeaponHint');
          if(p){
            if(lvlEl) lvlEl.textContent = p.level||1;
            if(xpEl) xpEl.textContent = p.next ? Math.round(p.xp/p.next*100)+'%' : '0%';
            if(xpFill) xpFill.style.width = (p.next? (p.xp/p.next*100):0)+'%';
            if(xpHint) xpHint.textContent = (p.xp||0)+' / '+(p.next||0);
            // HP Update (Mini-Bar)
            const hpFill = document.getElementById('hudHpFill');
            const hpGhost = document.getElementById('hudHpGhost');
            const hpHint = document.getElementById('hudHpHint');
            const hpBar = document.getElementById('hudHpBar');
            if(hpFill && hpGhost && hpHint && hpBar){
              let hp = p.hp!=null? p.hp: (p.curHp||0);
              let maxHp = p.maxHp!=null? p.maxHp: (p.hpMax||hp||1);
              if(maxHp<=0) maxHp = 1;
              if(hp>maxHp) hp = maxHp;
              const pct = Math.max(0, Math.min(1, hp/maxHp));
              const pct100 = (pct*100);
              hpFill.style.width = pct100+'%';
              // Ghost HP (verz√∂gert fallend)
              const curGhost = parseFloat(hpGhost.style.width)||pct100;
              if(pct100 < curGhost){
                // sanft senken
                const drop = (curGhost - pct100) * 0.04; // easing faktor
                const nextGhost = (curGhost - drop);
                hpGhost.style.width = (nextGhost < pct100 ? pct100 : nextGhost)+'%';
              } else {
                // Heilung -> sofort anpassen
                hpGhost.style.width = pct100+'%';
              }
              // Text
              hpHint.textContent = 'HP '+ Math.round(hp) +' / '+ Math.round(maxHp) + ' ('+Math.round(pct100)+'%)';
              // Low HP Effekt
              if(pct < 0.25) hpBar.classList.add('low'); else hpBar.classList.remove('low');
            }
          }
          if(typeof window.totalKills!=='undefined' && killsEl) killsEl.textContent = window.totalKills;
          if(starsEl){ try { const nameEl=document.getElementById('playerName'); if(nameEl){ const t=nameEl.textContent; const m=t.match(/‚òÖ/g); let count=0; if(m) count=m.length; const mult = (t.match(/x(\d+)/)||[])[1]; if(mult) count = parseInt(mult,10); starsEl.textContent = count; } } catch(_e){ }
          }
          if(dmgEl){ const base = (p && p.dmg)||0; dmgEl.textContent = Math.round(base); }
          if(apsEl){ // Attack speed (Angriffe pro Sekunde) falls sword cooldown existiert
            let aps='-'; try { if(p && p.weaponCooldown){ aps = (1/ p.weaponCooldown).toFixed(2); } } catch(_e){}
            apsEl.textContent = aps;
          }
            if(msEl){ msEl.textContent = p ? Math.round(p.speed) : 0; }
          if(wLvlEl){
            let w=null; try { if(window.player && window.weapons && Array.isArray(window.weapons) && window.player.weaponIndex!=null){ w=window.weapons[window.player.weaponIndex]; } } catch(_e){}
            const wl = w && typeof w.lvl==='number' ? w.lvl : 1; wLvlEl.textContent = wl;
            if(wFill){ let cap= (typeof getWeaponLevelCap==='function') ? getWeaponLevelCap():30; wFill.style.width = (wl/cap*100)+'%'; }
            if(wHint){ wHint.textContent = 'Wpn '+ (w? w.lvl:1); }
          }
          // Buff-Mirroring & Auto-Hide
          // Buff-Mirroring deaktiviert
        } catch(err){ /* swallow */ }
        requestAnimationFrame(update);
      }
      requestAnimationFrame(update);
    })();
  </script>
  <style>
    /* Weapon Level Badge Styling */
    #abilityBar .ab-slot.basic .icon{position:relative;}
  #abilityBar .ab-slot .w-lvl-badge{position:absolute;bottom:2px;right:3px;background:rgba(0,0,0,0.55);color:#ffe6a8;font-weight:600;font-size:9px;line-height:1;display:flex;align-items:center;justify-content:center;padding:2px 4px;border-radius:6px;border:1px solid #000;box-shadow:0 0 4px #000a;min-width:auto;min-height:auto;font-family:'Montserrat','Orbitron',sans-serif;letter-spacing:.3px;text-shadow:0 1px 2px #000;} 
  #abilityBar .ab-slot .w-lvl-badge.double{font-size:8px;padding:2px 4px;}
    #abilityBar .ab-slot.basic.ready-pulse .w-lvl-badge{animation:badgePulse 0.85s ease;}
    @keyframes badgePulse{0%{transform:scale(.8);filter:brightness(.7);}45%{transform:scale(1.15);filter:brightness(1.35);}100%{transform:scale(1);filter:brightness(1);}}
  </style>
  <script>
    // Sanity Check: Falls script.js NICHT geladen wurde (z.B. 404), Hinweis anzeigen
    window.addEventListener('DOMContentLoaded', () => {
      setTimeout(() => {
        if(!window.state || !window.player) {
          const warn = document.createElement('div');
          warn.style.position='fixed';
          warn.style.inset='0';
          warn.style.display='flex';
          warn.style.flexDirection='column';
          warn.style.alignItems='center';
          warn.style.justifyContent='center';
          warn.style.background='linear-gradient(135deg,#1b1b22,#0e0e12)';
          warn.style.color='#ffe600';
          warn.style.fontFamily='Consolas, monospace';
          warn.style.fontSize='18px';
          warn.style.zIndex='100000';
          warn.style.padding='40px';
          warn.innerHTML = '<div style="max-width:760px;text-align:center;line-height:1.4;">'+
            '<h2 style="margin:0 0 18px;font-size:34px;letter-spacing:2px;">Haupt-Script fehlt</h2>'+
            '<p style="margin:0 0 12px;">Die Datei <code>js/script.js</code> wurde nicht initialisiert (Pfad fr√ºher evtl. falsch: <code>../js/script.js</code>).<br>Pfad wurde jetzt korrigiert. Falls weiterhin leer: Browser-Konsole (F12) √∂ffnen und 404 / Fehler pr√ºfen.</p>'+
            '<p style="margin:0 0 18px;color:#ccc;">Wenn du die <strong>alte Version</strong> suchst: OneDrive Versionsverlauf oder VS Code Timeline verwenden.<br>Frag mich einfach: "Versionsverlauf Hilfe".</p>'+
            '<button id="dismissScriptWarn" style="margin-top:6px;padding:10px 26px;border:1px solid #ffe600;background:#23232a;color:#ffe600;font-weight:700;border-radius:10px;cursor:pointer;">Weiter trotzdem anzeigen</button>'+
          '</div>';
          document.body.appendChild(warn);
          document.getElementById('dismissScriptWarn').onclick = ()=> warn.remove();
        }
      }, 350); // kurze Verz√∂gerung, damit script.js Zeit zum Ausf√ºhren hat
    });
  </script>
  <script>
    // F F√§higkeit (Curse) UI
    (function initFAbilityUI(){
      function ensureLayer(id,color){ const host=document.getElementById(id); if(!host) return; if(!host.querySelector('.cd-slice')){ const layer=document.createElement('div'); layer.className='cd-slice'; layer.style.setProperty('--cd-color', color); host.appendChild(layer);} }
      ensureLayer('actionFIcon','#7d48ff');
      const block = document.getElementById('fActionBlock');
      if(block && !block.__wired){ block.__wired=true; block.addEventListener('click', ()=>{ const ev=new KeyboardEvent('keydown',{key:'f',code:'KeyF'}); window.dispatchEvent(ev); }); }
      function updateF(){
        const c = window.curseSkill; const label=document.getElementById('actionFLabel'); const desc=document.getElementById('actionFDesc'); if(!label||!desc) return;
        if(!c){ desc.textContent='...'; return; }
        if(c.timer>0){ desc.textContent = 'CD '+c.timer.toFixed(1)+'s'; }
        else if(c.targeting){ desc.textContent = 'Zielen...'; }
        else if(c.state==='windup'){ desc.textContent = 'Sog...'; }
        else if(c.state==='impact'){ if(!c.impactDone) desc.textContent = 'Energie...'; else desc.textContent='Entladung'; }
        else if(c.state==='idle'){ desc.textContent='Bereit'; }
        else if(c.state==='done'){ desc.textContent='Abk√ºhlen'; }
      }
      function updateBar(){
        const bar=document.getElementById('actionFCd'); const icon=document.getElementById('actionFIcon'); if(!bar||!icon) return; const c=window.curseSkill; if(!c){ bar.style.width='0%'; return; }
        const cd=c.cd; const t=c.timer; let pct= cd>0 ? 1 - Math.max(0, Math.min(1, t/cd)) : 0; bar.style.width=(pct*100)+'%'; const slice=icon.querySelector('.cd-slice'); if(slice) slice.style.setProperty('--cd-pct', pct);
        if(t>0){ icon.classList.add('dimmed'); icon.classList.remove('ready-pulse'); } else { if(icon.classList.contains('dimmed')){ icon.classList.add('ready-pulse'); setTimeout(()=>icon.classList.remove('ready-pulse'),900);} icon.classList.remove('dimmed'); }
      }
      (function loop(){ updateF(); updateBar(); requestAnimationFrame(loop); })();
    })();
  </script>
  <script>
    // R F√§higkeit UI (Spin oder Meteor) Setup
    (function initRAbilityUI(){
      function ensureLayer(iconId,color){
        const host = document.getElementById(iconId); if(!host) return;
        if(!host.querySelector('.cd-slice')){
          const layer=document.createElement('div');
          layer.className='cd-slice';
          layer.style.setProperty('--cd-color', color);
          host.appendChild(layer);
        }
      }
      ensureLayer('actionRIcon', '#b448ff');

      const block = document.getElementById('rActionBlock');
      if(block && !block.__wired){
        block.__wired = true;
        block.addEventListener('click', ()=>{
          // Simuliere Tastendruck R -> nutze vorhandene Logik im globalen keydown handler
          const ev = new KeyboardEvent('keydown', {key:'r', code:'KeyR'});
          window.dispatchEvent(ev);
        });
      }

      function updateRLabel(){
        const labelEl = document.getElementById('actionRLabel');
        const descEl = document.getElementById('actionRDesc');
        if(!labelEl || !descEl) return;
        let char = (window.selectedCharacter||'').toLowerCase();
        if(!char && typeof character==='string') char = character.toLowerCase();
        const wArr = window.weapons; let w = null;
        if(window.player && wArr && Array.isArray(wArr) && window.player.weaponIndex!=null){
          w = wArr[window.player.weaponIndex];
        }
        let mode = '';
        if(char==='fred' && w && w.id==='sword'){ mode = 'spin'; }
        else if((char==='bully'||!char) && w && w.id==='staff'){ mode = 'meteor'; }
        if(mode==='spin'){
          labelEl.textContent = 'Wirbel (R)';
          const sp = window.swordSpin;
          if(sp){
            if(sp.timer>0){ descEl.textContent = 'CD '+sp.timer.toFixed(1)+'s'; }
            else if(sp.active){ descEl.textContent = 'Aktiv'; }
            else { descEl.textContent = 'Bereit'; }
          } else {
            descEl.textContent = '...';
          }
        } else if(mode==='meteor') {
          labelEl.textContent = 'Meteor (R)';
          const m = window.staffMeteor;
            if(m){
              if(m.timer>0){
                descEl.textContent = 'CD '+m.timer.toFixed(1)+'s';
              } else if(m.targeting){
                descEl.textContent = 'Zielen...';
              } else if(m.state==='windup'){
                descEl.textContent = 'Sog...';
              } else if(m.state==='impact'){
                const delayFrac = (typeof m.impactDelayFrac==='number'? m.impactDelayFrac:0.5);
                if(m.animT < m.animDur * delayFrac){
                  descEl.textContent = 'Einschlag...';
                } else if(!m.impactDone){
                  descEl.textContent = 'Kern...';
                } else {
                  descEl.textContent = 'Detonation';
                }
              } else if(m.state==='done'){
                descEl.textContent = 'Abk√ºhlen';
              } else if(m.state==='idle') {
                descEl.textContent = 'Bereit';
              } else {
                descEl.textContent = m.state;
              }
            } else { descEl.textContent = '...'; }
        } else {
          labelEl.textContent = 'Ult (R)';
          descEl.textContent = 'Nicht verf√ºgbar';
        }
      }

      function updateCooldownBar(){
        const bar = document.getElementById('actionRCd');
        const icon = document.getElementById('actionRIcon');
        const slice = icon && icon.querySelector('.cd-slice');
        if(!bar || !icon) return;
        let char = (window.selectedCharacter||'').toLowerCase();
        if(!char && typeof character==='string') char = character.toLowerCase();
        const wArr = window.weapons; let w=null;
        if(window.player && wArr && Array.isArray(wArr) && window.player.weaponIndex!=null){ w = wArr[window.player.weaponIndex]; }
        let cd=0, timer=0, pct=0;
        if(char==='fred' && w && w.id==='sword' && window.swordSpin){ cd = window.swordSpin.cd; timer = window.swordSpin.timer; }
        else if((char==='bully'||!char) && w && w.id==='staff' && window.staffMeteor){ cd = window.staffMeteor.cd; timer = window.staffMeteor.timer; }
        if(cd>0){ pct = 1 - Math.max(0, Math.min(1, timer / cd)); }
        bar.style.width = (pct*100).toFixed(1)+'%';
        if(slice){ slice.style.setProperty('--cd-pct', pct); }
        if(timer>0){ icon.classList.add('dimmed'); icon.classList.remove('ready-pulse'); }
        else { if(icon.classList.contains('dimmed')){ icon.classList.add('ready-pulse'); setTimeout(()=>icon.classList.remove('ready-pulse'), 900); } icon.classList.remove('dimmed'); }
      }

      function loop(){
        updateRLabel();
        updateCooldownBar();
        requestAnimationFrame(loop);
      }
      requestAnimationFrame(loop);
    })();
  </script>
  <script>
    // Inject cooldown slice layers after script load
    (function(){
      function ensureLayer(id, color){
        const host = document.getElementById(id);
        if(!host) return;
        if(!host.querySelector('.cd-slice')){
          const layer = document.createElement('div');
          layer.className = 'cd-slice';
          layer.style.setProperty('--cd-color', color);
          host.appendChild(layer);
        }
      }
  // Nach Tausch: Q = Dash (blau), E = Heal (gelb)
  ensureLayer('actionQIcon', '#38e1d7');
  ensureLayer('actionEIcon', '#ffe600');

      // Patch existing ability UI updater if present, else poll until available
      function attach(){
        if(!window.actionKeyState) { requestAnimationFrame(attach); return; }
        // Wrap updateActionKeyUI to also update radial overlay
        const prev = window.updateActionKeyUI;
        window.updateActionKeyUI = function(dt){
          if(prev) prev(dt);
          const q = window.actionKeyState.q; const e = window.actionKeyState.e;
          updateIcon('actionQIcon', q);
          updateIcon('actionEIcon', e);
        };
      }
      function updateIcon(iconId, st){
        const el = document.getElementById(iconId); if(!el || !st) return;
        const slice = el.querySelector('.cd-slice'); if(!slice) return;
        const pct = st.timer>0 ? (st.timer / st.cd) : 0;
        slice.style.setProperty('--cd-pct', (1-pct));
        if(st.timer>0){
          el.classList.add('dimmed');
          el.classList.remove('ready-pulse');
        } else {
          if(el.classList.contains('dimmed')){
            // just finished
            el.classList.add('ready-pulse');
            setTimeout(()=>el.classList.remove('ready-pulse'), 900);
          }
          el.classList.remove('dimmed');
        }
      }
      attach();
    })();
  </script>
  <script>
    // Beim Klick auf Start-Button: Auswahl aus Dropdowns √ºbernehmen
    document.addEventListener('DOMContentLoaded', function() {
      var startBtn = document.getElementById('startBtn');
      if(startBtn) {
        startBtn.onclick = function() {
          var charSel = document.getElementById('charSelectStart');
          var weaponSel = document.getElementById('weaponSelectStart');
          if(charSel && weaponSel) {
            window.selectedCharacter = charSel.value.toLowerCase();
            var wv = weaponSel.value.toLowerCase();
            if(wv === 'halberd') wv = 'halbard';
            window.selectedWeaponId = wv;
            window.__userSelectionCommitted = true;
            // Info Box aktualisieren
            var info = document.getElementById('nextStartInfo');
            if(info) info.textContent = 'N√§chster Start: ' + (window.selectedCharacter.charAt(0).toUpperCase()+window.selectedCharacter.slice(1)) + ' / ' + (window.selectedWeaponId.charAt(0).toUpperCase()+window.selectedWeaponId.slice(1));
            // Startmen√º schlie√üen & Spiel wirklich starten
            var sm = document.getElementById('startMenu');
            if(sm) sm.classList.remove('show');
            if(typeof restart === 'function') restart();
            // Falls Loop pausiert war, sicherstellen dass running aktiv ist
            if(window.state) { window.state.running = true; window.state.lastTime = performance.now(); }
          }
        };
      }
    });
  </script>
  <script>
  // --- Charakter/Waffen Synergie Tooltip --------------------------------------
  // Nutzt die bereits vorhandene Box #charInfoBox und blendet sie ein, sobald eine Auswahl erfolgt.
  // Interne Waffen-Namen beachten: "Halbarde" (Anzeige) => "halbard" (intern)
  (function(){
    const BOX_ID = 'charInfoBox';
    const box = document.getElementById(BOX_ID);
    if(!box) return;
    // Auff√§lliger machen
    box.style.border = '1px solid #ffe60055';
    box.style.background = 'linear-gradient(135deg,#2d2d33,#23232a 55%)';
    box.style.boxShadow = '0 0 0 1px #000 inset,0 4px 14px #000c,0 0 24px -4px #ffe60033';

    const SYNERGY = {
      fred: {
  sword: 'Fred + Schwert: +15% Schaden. Sein Standard ‚Äì stabiler Cleave und verl√§ssliche Skalierung.',
  halbard: 'Fred + Halbarde: +15% Schaden. Reichweite + Fl√§chenkontrolle f√ºr Elites & Boss-Fenster.',
  dagger: 'Fred + Dolch: Lernphase (‚àí30% Schaden). Schnelle Technik liegt ihm anfangs nicht.',
  staff: 'Fred + Stab: Lernphase (‚àí30% Schaden). Magische Distanz ist ungewohnt f√ºr ihn.'
      },
      bully: {
  sword: 'Bully + Schwert: Lernphase (‚àí30% Schaden). Klassische Klinge noch unge√ºbt.',
  halbard: 'Bully + Halbarde: Lernphase (‚àí30% Schaden). Timing & Schwung noch unsauber.',
  dagger: 'Bully + Dolch: +20% Angriffstempo. Aggressive Hit-Frequenz & DoT-Synergien.',
  staff: 'Bully + Stab: +20% Angriffstempo. Mobilit√§t + Reichweite f√ºr permanentes Kiten.'
      }
    };

    function mapWeaponValue(v){
      if(!v) return ''; 
      const l = v.toLowerCase();
    if(l === 'halbarde' || l === 'halberd') return 'halbard';
      return l;
    }

    function niceWeaponName(internal){
      if(internal === 'halbard') return 'Halbarde';
      if(!internal) return '';
      return internal.charAt(0).toUpperCase()+internal.slice(1);
    }

    let _lastContent = '';
    function updateSynergy(showAlways){
      const charSel = document.getElementById('charSelectStart');
      const weaponSel = document.getElementById('weaponSelectStart');
      if(!charSel || !weaponSel) return;
      const charVal = (charSel.value||'').toLowerCase();
      const weaponVal = mapWeaponValue(weaponSel.value||'');
      if(!charVal || !weaponVal) return;
      const charKey = charVal === 'bully' ? 'bully' : 'fred';
      const text = (SYNERGY[charKey] && SYNERGY[charKey][weaponVal]) || 'Keine Synergie-Info vorhanden.';
      const html = '<div style="font-size:13px;letter-spacing:0.3px;"><div style="font-weight:700;color:#ffe600;margin-bottom:4px;display:flex;align-items:center;gap:6px;">üîó Synergie <span style=\"font-size:10px;padding:2px 6px;border-radius:4px;background:#ffe60022;color:#ffe600;font-weight:600;\">Info</span></div>'+ text + '<div style="margin-top:6px;font-size:11px;opacity:0.7;">Char: <strong>'+charSel.value+'</strong> ‚Ä¢ Waffe: <strong>'+niceWeaponName(weaponVal)+'</strong></div></div>';
      if(html === _lastContent) { box.style.display = 'block'; return; }
      _lastContent = html;
      box.innerHTML = html;
      box.style.display = 'block';
      if(!showAlways){
        // Optional: sanftes Aufblenden
        box.style.transition = 'background 0.3s, box-shadow 0.3s';
        box.style.background = '#23232a';
      }
    }

    // Events
    ['charSelectStart','weaponSelectStart'].forEach(id => {
      const el = document.getElementById(id);
      if(!el) return;
      el.addEventListener('change', ()=>updateSynergy(true));
      el.addEventListener('mouseenter', ()=>updateSynergy(false));
      el.addEventListener('focus', ()=>updateSynergy(false));
    });

    // Initial beim Laden einmal anzeigen
    // Wiederholter Versuch, falls DOM noch nicht fertig oder Werte noch nicht gebunden.
    function initLoop(attempt=0){
      updateSynergy(true);
      if(attempt < 10) setTimeout(()=>initLoop(attempt+1), 150);
    }
    if(document.readyState === 'loading') {
      window.addEventListener('DOMContentLoaded', ()=>initLoop());
    } else {
      initLoop();
    }
  })();
  </script>

  <script>
    // Auswahl speichern + Lock/Unlock Toggle
    document.addEventListener('DOMContentLoaded', function() {
  var saveBtn = document.getElementById('savePreviewSelectionBtn');
  var startBtn = document.getElementById('startBtn');
      var charSel = document.getElementById('charSelectStart');
      var weaponSel = document.getElementById('weaponSelectStart');
      window.selectionLocked = false;
      function applySelection(updateInfo){
        if(!charSel || !weaponSel) return;
        var charVal = charSel.value.toLowerCase();
        var weaponVal = weaponSel.value.toLowerCase();
        if(weaponVal === 'halberd') weaponVal = 'halbard';
        window.selectedCharacter = charVal;
        window.selectedWeaponId = weaponVal;
        window.__userSelectionCommitted = true;
        if(updateInfo){
          var info = document.getElementById('nextStartInfo');
          if(info) info.textContent = 'N√§chster Start: ' + (charVal.charAt(0).toUpperCase()+charVal.slice(1)) + ' / ' + (weaponVal.charAt(0).toUpperCase()+weaponVal.slice(1));
        }
      }
      function lockUI(){
        if(charSel) charSel.disabled = true;
        if(weaponSel) weaponSel.disabled = true;
        window.selectionLocked = true;
        if(saveBtn){
          saveBtn.classList.add('locked-selection');
          // Text bleibt unver√§ndert; nur Leuchteffekt entfernen durch CSS-Klasse
        }
        if(startBtn){
          startBtn.disabled = false;
          startBtn.classList.remove('disabled-start');
        }
      }
      function unlockUI(){
        if(charSel) charSel.disabled = false;
        if(weaponSel) weaponSel.disabled = false;
        window.selectionLocked = false;
        if(saveBtn){
          saveBtn.classList.remove('locked-selection');
          // Originaltext bleibt bestehen
        }
        if(startBtn){
          startBtn.disabled = true;
          if(!startBtn.classList.contains('disabled-start')) startBtn.classList.add('disabled-start');
        }
      }
      if(startBtn){
        startBtn.disabled = true;
        startBtn.classList.add('disabled-start');
      }
      if(saveBtn){
        saveBtn.addEventListener('click', function(){
          if(!window.selectionLocked){
            applySelection(true);
            lockUI();
          } else {
            unlockUI();
          }
        });
      }
    });
  </script>
  <script src="./js/score.js"></script>
  <script src="./js/spritePreview.js"></script>

<script>
</script>

<script>
function updateTestModeIndicator() {
  var btn = document.getElementById('forceTestModeBtn');
  if(!btn) return;
  btn.textContent = 'Test Modus';
  if(window.TESTMODE) {
    btn.style.background = '#c00';
    btn.style.color = '#fff';
    btn.style.boxShadow = '0 0 18px 4px #f00,0 0 2px #000';
  } else {
    btn.style.background = '#333';
    btn.style.color = '#fff';
    btn.style.boxShadow = '0 0 8px #000a';
  }
}
if(window.TESTMODE !== undefined) updateTestModeIndicator();
if(window.onTestModeToggle) {
  var orig = window.onTestModeToggle;
  window.onTestModeToggle = function(active) {
    orig(active);
    updateTestModeIndicator();
  }
}
setInterval(updateTestModeIndicator, 1000);

document.getElementById('forceTestModeBtn').onclick = function() {
  window.TESTMODE = !window.TESTMODE;
  if(typeof onTestModeToggle === 'function') onTestModeToggle(window.TESTMODE);
  updateTestModeIndicator();
}
</script>


<script>
function updateSpritePreview() {
  const char = document.getElementById('charSelectStart').value;
  const weapon = document.getElementById('weaponSelectStart').value;
  // Sprite-Sheet f√ºr Charakter
  let charSprite = char.toLowerCase() === 'bully'
    ? `img/Bully Animation/Bully ${weapon}/walk.png`
    : `img/Fred Animation/Fred ${weapon}/walk.png`;
  // Waffen-Overlay (optional, nur wenn existiert)
  let weaponSprite = null;
  // Pr√ºfe, ob ein Overlay f√ºr die Waffe existiert (z.B. slash_oversize.png, thrust_oversize.png)
  // Wir nehmen als Overlay das slash_oversize.png (Schwert, Halberd, Dagger) oder thrust_oversize.png (Staff, Dagger)
  if (weapon === 'Sword' || weapon === 'Halberd' || weapon === 'Dagger') {
    weaponSprite = char.toLowerCase() === 'bully'
      ? `img/Bully Animation/Bully ${weapon}/slash_oversize.png`
      : `img/Fred Animation/Fred ${weapon}/slash_oversize.png`;
  } else if (weapon === 'Staff') {
    weaponSprite = char.toLowerCase() === 'bully'
      ? `img/Bully Animation/Bully ${weapon}/thrust_oversize.png`
      : `img/Fred Animation/Fred ${weapon}/thrust_oversize.png`;
  }
  const canvas = document.getElementById('characterPreview');
  if (!canvas) return; // Canvas existiert nicht, keine Vorschau
  if(window.spritePrevInst) delete window.spritePrevInst;
  // Immer das Canvas 'characterPreview' verwenden
  window.spritePrevInst = new SpritePreview('characterPreview', charSprite, weaponSprite);
}
document.getElementById('charSelectStart').onchange = updateSpritePreview;
document.getElementById('weaponSelectStart').onchange = updateSpritePreview;
window.addEventListener('DOMContentLoaded', function() {
  updateSpritePreview();
});
</script>
<script>
// Hauptmen√º Button Logik
(function(){
  const btn = document.getElementById('mainMenuBtn');
  if(!btn) return;
  btn.addEventListener('click', function(){
    // Overlay ausblenden
    const go = document.getElementById('gameOver');
    if(go) go.classList.remove('show');
    // Startmen√º einblenden
    const sm = document.getElementById('startMenu');
    if(sm) sm.classList.add('show');
    // Spiel anhalten
    if(window.state){ window.state.running = false; window.state.dead = false; }
    // Score zur√ºcksetzen Anzeige
    const scoreDiv = document.getElementById('gameOverScore');
    if(scoreDiv) scoreDiv.textContent = 'Score: 0';
    // Auswahl wieder entsperren
    const charSel = document.getElementById('charSelectStart');
    const weaponSel = document.getElementById('weaponSelectStart');
    const saveBtn = document.getElementById('savePreviewSelectionBtn');
    const startBtn = document.getElementById('startBtn');
    if(charSel) charSel.disabled = false;
    if(weaponSel) weaponSel.disabled = false;
    if(saveBtn) saveBtn.classList.remove('locked-selection');
    if(startBtn){ startBtn.disabled = true; if(!startBtn.classList.contains('disabled-start')) startBtn.classList.add('disabled-start'); }
    window.selectionLocked = false;
    // Spielfeld Hard-Reset √ºber restart() nur wenn Spieler direkt neu startet; hier kein auto-restart
  });
})();
</script>
</body>
</html>
